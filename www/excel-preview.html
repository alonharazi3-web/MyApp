<!DOCTYPE html>
<html dir="rtl" lang="he">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>×ª×¦×•×’×” ××§×“×™××” - Excel</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            background: #f5f5f5;
            padding: 10px;
        }
        .header {
            background: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: sticky;
            top: 10px;
            z-index: 100;
        }
        .header h1 {
            color: #667eea;
            font-size: 20px;
            margin-bottom: 10px;
        }
        .button-row {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 10px;
        }
        .btn {
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn:active {
            transform: scale(0.95);
        }
        .btn-share {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }
        .btn-download {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
        }
        .btn-close {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
        }
        .preview {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            white-space: pre-wrap;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.6;
            overflow-x: auto;
        }
        .status {
            background: #d1fae5;
            color: #065f46;
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            text-align: center;
            font-size: 13px;
            display: none;
        }
        .status.show {
            display: block;
        }
        .status.error {
            background: #fee2e2;
            color: #991b1b;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ“Š ×ª×¦×•×’×” ××§×“×™××” - Excel</h1>
        <div class="button-row">
            <button class="btn btn-share" onclick="shareExcel()">
                ğŸ“¤ ×©×™×ª×•×£
            </button>
            <button class="btn btn-download" onclick="downloadExcel()">
                ğŸ’¾ ×”×•×¨×“×”
            </button>
            <button class="btn btn-close" onclick="window.close()">
                âœ–ï¸ ×¡×’×•×¨
            </button>
        </div>
        <div id="status" class="status"></div>
    </div>
    
    <div class="preview" id="preview">×˜×•×¢×Ÿ × ×ª×•× ×™×...</div>

    <script>
        let csvContent = '';
        let appData = null;

        function showStatus(message, isError = false) {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = 'status show' + (isError ? ' error' : '');
            setTimeout(() => {
                status.className = 'status';
            }, 3000);
        }

        function generateCSV(data) {
            let csv = '\uFEFF'; // UTF-8 BOM
            
            csv += '×©× ×”×”×¢×¨×›×”,' + (data.assessmentName || '') + '\n';
            csv += '××¢×¨×™×š,' + (data.evaluatorName || '') + '\n';
            csv += '×ª××¨×™×š,' + new Date().toLocaleDateString('he-IL') + '\n\n';
            
            csv += '=== ×—× ×™×›×™× ===\n';
            for (let i = 1; i <= 4; i++) {
                csv += i + '. ' + (data['trainee' + i] || '×œ× ××•×œ×') + '\n';
            }
            csv += '\n';
            
            csv += '=== ×“×’×©×™× ===\n';
            csv += (data.highlights || '×œ× ××•×œ×') + '\n\n';
            
            csv += '=== ×”×™×¡×˜×•×¨×™×™×ª ×—× ×•×™×•×ª (×˜×™×—) ===\n';
            csv += '×©×,×›×ª×•×‘×ª,×ª××¨×™×š,×”×¢×¨×•×ª\n';
            if (data.storeHistory && data.storeHistory.length > 0) {
                data.storeHistory.forEach(s => {
                    csv += (s.name || '') + ',' + (s.address || '') + ',' + (s.date || '') + ',' + (s.notes || '') + '\n';
                });
            } else {
                csv += '××™×Ÿ × ×ª×•× ×™×\n';
            }
            csv += '\n';
            
            csv += '=== ×”×™×¡×˜×•×¨×™×™×ª ××œ×•× ×•×ª (×œ×™×œ×”/×™×•××™× ×˜) ===\n';
            csv += '×©×,×›×ª×•×‘×ª,×ª××¨×™×š,×”×¢×¨×•×ª\n';
            if (data.hotelHistory && data.hotelHistory.length > 0) {
                data.hotelHistory.forEach(h => {
                    csv += (h.name || '') + ',' + (h.address || '') + ',' + (h.date || '') + ',' + (h.notes || '') + '\n';
                });
            } else {
                csv += '××™×Ÿ × ×ª×•× ×™×\n';
            }
            csv += '\n';
            
            // ×”×•×¡×£ × ×ª×•× ×™ ×ª×¨×’×™×œ×™× ×× ×™×©
            if (data.exerciseData) {
                csv += '=== × ×ª×•× ×™ ×ª×¨×’×™×œ×™× ===\n';
                for (let key in data.exerciseData) {
                    const exerciseData = data.exerciseData[key];
                    if (exerciseData && Object.keys(exerciseData).length > 0) {
                        csv += `\n×ª×¨×’×™×œ ${key}:\n`;
                        for (let field in exerciseData) {
                            csv += `  ${field}: ${exerciseData[field]}\n`;
                        }
                    }
                }
                csv += '\n';
            }
            
            // ×”×•×¡×£ ×¡×™×›×•× ×× ×™×©
            if (data.summaryData) {
                csv += '=== ×¡×™×›×•× ×›×œ×œ×™ ===\n';
                for (let key in data.summaryData) {
                    csv += `${key}:\n`;
                    const summary = data.summaryData[key];
                    for (let field in summary) {
                        csv += `  ${field}: ${summary[field]}\n`;
                    }
                    csv += '\n';
                }
            }
            
            return csv;
        }

        function shareExcel() {
            if (!csvContent) {
                showStatus('âŒ ××™×Ÿ × ×ª×•× ×™× ×œ×©×™×ª×•×£', true);
                return;
            }

            const filename = '××©×•×‘-×¡×“× ×”_' + new Date().toISOString().slice(0, 10) + '.csv';
            
            // × ×¡×” Navigator Share API
            if (navigator.share) {
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const file = new File([blob], filename, { type: 'text/csv' });
                
                navigator.share({
                    files: [file],
                    title: '××©×•×‘ ×¡×“× ×”',
                    text: '×§×•×‘×¥ Excel - ××©×•×‘ ×¡×“× ×ª ××™××¤×¨×•×‘×™×–×¦×™×”'
                }).then(() => {
                    showStatus('âœ… ×©×•×ª×£ ×‘×”×¦×œ×—×”!');
                }).catch((error) => {
                    console.error('Share failed:', error);
                    // fallback - ×ª×¦×™×’ ××¤×©×¨×•×™×•×ª ××—×¨×•×ª
                    showShareOptions();
                });
            } else {
                showShareOptions();
            }
        }

        function showShareOptions() {
            const choice = confirm(
                'ğŸ“¤ ×©×™×ª×•×£ ×§×•×‘×¥\n\n' +
                '×‘×—×¨:\n' +
                '××™×©×•×¨ (OK) = ×©×™×ª×•×£ ×“×¨×š WhatsApp\n' +
                '×‘×™×˜×•×œ (Cancel) = ×”×•×¨×“×” ×œ××›×©×™×¨'
            );
            
            if (choice) {
                // WhatsApp
                downloadExcel();
                setTimeout(() => {
                    alert('ğŸ“± ×”×§×•×‘×¥ ×”×•×¨×“!\n\n×¢×›×©×™×•:\n1. ×¤×ª×— WhatsApp\n2. ×‘×—×¨ ×©×™×—×”\n3. ×œ×—×¥ ğŸ“\n4. ×‘×—×¨ "××¡××š"\n5. ××¦× ××ª ×”×§×•×‘×¥');
                }, 500);
            } else {
                // ×¨×’×™×œ
                downloadExcel();
            }
        }

        function downloadExcel() {
            if (!csvContent) {
                showStatus('âŒ ××™×Ÿ × ×ª×•× ×™× ×œ×”×•×¨×“×”', true);
                return;
            }

            try {
                const filename = '××©×•×‘-×¡×“× ×”_' + new Date().toISOString().slice(0, 10) + '.csv';
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                
                // ×©×™×˜×” 5 - ×”×›×™ ×××™× ×”
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                setTimeout(() => {
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                }, 100);
                
                showStatus('âœ… ×”×§×•×‘×¥ ×”×•×¨×“ ×‘×”×¦×œ×—×”!');
            } catch (error) {
                showStatus('âŒ ×©×’×™××”: ' + error.message, true);
            }
        }

        // ×˜×¢×Ÿ × ×ª×•× ×™×
        window.addEventListener('load', function() {
            try {
                const stored = localStorage.getItem('feedbackAppData');
                if (stored) {
                    appData = JSON.parse(stored);
                    csvContent = generateCSV(appData);
                    
                    // ×”×¦×’ ×ª×¦×•×’×” ××§×“×™××”
                    document.getElementById('preview').textContent = csvContent;
                    showStatus('âœ… ××•×›×Ÿ ×œ×©×™×ª×•×£ ××• ×”×•×¨×“×”!');
                } else {
                    document.getElementById('preview').textContent = 'âŒ ×œ× × ××¦××• × ×ª×•× ×™×';
                    showStatus('âŒ ×œ× ×”×ª×§×‘×œ×• × ×ª×•× ×™×', true);
                }
            } catch (error) {
                document.getElementById('preview').textContent = 'âŒ ×©×’×™××”: ' + error.message;
                showStatus('âŒ ×©×’×™××” ×‘×˜×¢×™× ×ª × ×ª×•× ×™×', true);
            }
        });
    </script>
</body>
</html>

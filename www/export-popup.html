<!DOCTYPE html>
<html dir="rtl" lang="he">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>×™×™×¦×•× ×§×‘×¦×™×</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 15px;
        }
        .container {
            background: white;
            border-radius: 20px;
            padding: 25px;
            max-width: 650px;
            margin: 0 auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        h1 { color: #667eea; margin-bottom: 8px; font-size: 24px; text-align: center; }
        .subtitle { text-align: center; color: #666; margin-bottom: 20px; font-size: 13px; }
        .file-type {
            background: #f3f4f6;
            padding: 12px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: bold;
            color: #374151;
        }
        .methods { display: grid; gap: 10px; margin-bottom: 15px; }
        .method-btn {
            padding: 14px 18px;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            background: white;
            cursor: pointer;
            transition: all 0.2s;
            text-align: right;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .method-btn:hover { border-color: #667eea; background: #f9fafb; transform: translateY(-2px); }
        .method-btn:active { transform: translateY(0); }
        .method-num {
            background: #667eea;
            color: white;
            padding: 5px 11px;
            border-radius: 6px;
            font-weight: bold;
            font-size: 13px;
            min-width: 75px;
            text-align: center;
        }
        .method-desc { flex: 1; color: #374151; font-weight: 500; font-size: 14px; }
        .status {
            background: #f3f4f6;
            padding: 12px;
            border-radius: 8px;
            margin-top: 15px;
            font-size: 13px;
            color: #374151;
            min-height: 50px;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .status.success { background: #d1fae5; color: #065f46; }
        .status.error { background: #fee2e2; color: #991b1b; }
        .btn-close {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 8px;
            background: #ef4444;
            color: white;
            font-weight: bold;
            cursor: pointer;
            margin-top: 15px;
        }
        .btn-close:active { transform: scale(0.98); }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“Š ×™×™×¦×•× ×§×‘×¦×™×</h1>
        <p class="subtitle">×‘×—×¨ ×©×™×˜×ª ×©××™×¨×”</p>
        
        <div class="file-type" id="fileType">×˜×•×¢×Ÿ...</div>
        
        <div class="methods">
            <button class="method-btn" onclick="saveMethod(5)">
                <span class="method-num">×©×™×˜×” 5</span>
                <span class="method-desc">Object URL (××•××œ×¥)</span>
            </button>
            
            <button class="method-btn" onclick="saveMethod(3)">
                <span class="method-num">×©×™×˜×” 3</span>
                <span class="method-desc">Blob Download</span>
            </button>
            
            <button class="method-btn" onclick="saveMethod(4)">
                <span class="method-num">×©×™×˜×” 4</span>
                <span class="method-desc">Data URL</span>
            </button>
            
            <button class="method-btn" onclick="saveMethod(8)">
                <span class="method-num">×©×™×˜×” 8</span>
                <span class="method-desc">Window.open</span>
            </button>
            
            <button class="method-btn" onclick="saveMethod('cascade')">
                <span class="method-num">××¤×œ ×—×›×</span>
                <span class="method-desc">× ×¡×” ×”×›×œ ×¢×“ ×©×¢×•×‘×“</span>
            </button>
        </div>
        
        <div id="status" class="status">×‘×—×¨ ×©×™×˜×”...</div>
        
        <button class="btn-close" onclick="closeWindow()">âœ–ï¸ ×¡×’×•×¨</button>
    </div>

    <script>
        let appData = null;
        let exportType = 'excel';
        let fileContent = '';
        let filename = '';

        function loadData() {
            try {
                const stored = localStorage.getItem('feedbackAppData');
                const type = localStorage.getItem('exportType') || 'excel';
                exportType = type;
                
                if (stored) {
                    appData = JSON.parse(stored);
                    console.log('âœ… Data loaded');
                    generateFileContent();
                    updateUI();
                } else {
                    showStatus('âŒ ×œ× × ××¦××• × ×ª×•× ×™×!', false);
                }
            } catch (e) {
                showStatus('âŒ ×©×’×™××” ×‘×˜×¢×™× ×”', false);
            }
        }

        function generateFullCSV(data) {
            let csv = '\uFEFF';
            
            csv += '=== × ×ª×•× ×™ ×”×¢×¨×›×” ===\n\n';
            csv += '×©××œ×”: ×©× ×”×”×¢×¨×›×”\n×ª×©×•×‘×”: ' + (data.assessmentName || '×œ× ××•×œ×') + '\n\n';
            csv += '×©××œ×”: ×©× ×”××¢×¨×™×š\n×ª×©×•×‘×”: ' + (data.evaluatorName || '×œ× ××•×œ×') + '\n\n';
            csv += '×ª××¨×™×š: ' + new Date().toLocaleDateString('he-IL') + '\n\n';
            
            csv += '=== ×—× ×™×›×™× ===\n\n';
            for (let i = 1; i <= 4; i++) {
                csv += '×©××œ×”: ×—× ×™×š ' + i + '\n×ª×©×•×‘×”: ' + (data['trainee' + i] || '×œ× ××•×œ×') + '\n\n';
            }
            
            csv += '×©××œ×”: ×“×’×©×™× ×›×œ×œ×™×™×\n×ª×©×•×‘×”: ' + (data.highlights || '×œ× ××•×œ×') + '\n\n';
            
            // ×›×œ 7 ×”×ª×¨×’×™×œ×™×
            const exercises = [
                {name: '×‘×œ×•×Ÿ', prefix: 'balloon', fields: [{key: '×’××™×©×•×ª', label: '×’××™×©×•×ª ××—×©×‘×ª×™×ª'}, {key: '×ª×›× ×•×Ÿ', label: '×ª×›× ×•×Ÿ'}, {key: '×œ×—×¥', label: '×œ×—×¥ ×•×¢××™××•×ª'}, {key: 'notes', label: '×”×¢×¨×•×ª'}]},
                {name: '×˜×™×—', prefix: 'tiach', fields: [{key: 'store', label: '×—× ×•×ª'}, {key: 'score', label: '×¦×™×•×Ÿ'}, {key: 'notes', label: '×”×¢×¨×•×ª'}]},
                {name: '×“×•×œ×™×¨×”', prefix: 'dolira', fields: [{key: 'time', label: '×–××Ÿ'}, {key: 'quality', label: '××™×›×•×ª'}]},
                {name: '×“×•×“', prefix: 'david', fields: [{key: 'score', label: '×¦×™×•×Ÿ'}, {key: 'notes', label: '×”×¢×¨×•×ª'}]},
                {name: '×œ×™×œ×”', prefix: 'laila', fields: [{key: 'hotel', label: '××œ×•×Ÿ'}, {key: 'score', label: '×¦×™×•×Ÿ'}, {key: 'notes', label: '×”×¢×¨×•×ª'}]},
                {name: '××›×ª×‘', prefix: 'michtav', fields: [{key: 'score', label: '×¦×™×•×Ÿ'}, {key: 'notes', label: '×”×¢×¨×•×ª'}]},
                {name: '×™×•××™× ×˜', prefix: 'yominet', fields: [{key: 'hotel', label: '××œ×•×Ÿ'}, {key: 'score', label: '×¦×™×•×Ÿ'}, {key: 'notes', label: '×”×¢×¨×•×ª'}]}
            ];
            
            exercises.forEach(ex => {
                csv += `=== ×ª×¨×’×™×œ ${ex.name} ===\n\n`;
                for (let t = 0; t < 4; t++) {
                    const traineeName = data['trainee' + (t + 1)] || `×—× ×™×š ${t + 1}`;
                    csv += `×—× ×™×š: ${traineeName}\n`;
                    
                    ex.fields.forEach(field => {
                        const key = `${ex.prefix}-${t}-${field.key}`;
                        csv += `  ×©××œ×”: ${field.label}\n`;
                        csv += `  ×ª×©×•×‘×”: ${data[key] || '×œ× ××•×œ×'}\n`;
                    });
                    csv += '\n';
                }
            });
            
            csv += '=== ×”×™×¡×˜×•×¨×™×™×ª ×—× ×•×™×•×ª ===\n\n';
            if (data.storeHistory && data.storeHistory.length > 0) {
                data.storeHistory.forEach((s, i) => {
                    csv += `×—× ×•×ª ${i + 1}:\n  ×©×: ${s.name || '×œ× ××•×œ×'}\n  ×›×ª×•×‘×ª: ${s.address || '×œ× ××•×œ×'}\n  ×ª××¨×™×š: ${s.date || '×œ× ××•×œ×'}\n  ×”×¢×¨×•×ª: ${s.notes || '×œ× ××•×œ×'}\n\n`;
                });
            } else {
                csv += '××™×Ÿ × ×ª×•× ×™×\n\n';
            }
            
            csv += '=== ×”×™×¡×˜×•×¨×™×™×ª ××œ×•× ×•×ª ===\n\n';
            if (data.hotelHistory && data.hotelHistory.length > 0) {
                data.hotelHistory.forEach((h, i) => {
                    csv += `××œ×•×Ÿ ${i + 1}:\n  ×©×: ${h.name || '×œ× ××•×œ×'}\n  ×›×ª×•×‘×ª: ${h.address || '×œ× ××•×œ×'}\n  ×ª××¨×™×š: ${h.date || '×œ× ××•×œ×'}\n  ×”×¢×¨×•×ª: ${h.notes || '×œ× ××•×œ×'}\n\n`;
                });
            } else {
                csv += '××™×Ÿ × ×ª×•× ×™×\n\n';
            }
            
            return csv;
        }

        function generateFileContent() {
            if (!appData) return;
            
            if (exportType === 'excel') {
                fileContent = generateFullCSV(appData);
                filename = '××©×•×‘-×¡×“× ×”_' + new Date().toISOString().slice(0, 10) + '.csv';
            } else {
                fileContent = JSON.stringify(appData, null, 2);
                filename = '×”×’×“×¨×•×ª-×× ×”×œ_' + new Date().toISOString().slice(0, 10) + '.json';
            }
        }

        function updateUI() {
            const fileTypeDiv = document.getElementById('fileType');
            if (exportType === 'excel') {
                fileTypeDiv.textContent = 'ğŸ“Š ×™×™×¦×•× Excel (CSV)';
                fileTypeDiv.style.background = 'linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%)';
            } else {
                fileTypeDiv.textContent = 'ğŸ“„ ×™×™×¦×•× JSON';
                fileTypeDiv.style.background = 'linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%)';
            }
        }

        function showStatus(message, isSuccess = true) {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = 'status ' + (isSuccess ? 'success' : 'error');
        }

        function saveMethod(method) {
            if (!fileContent) {
                showStatus('âŒ ××™×Ÿ ×ª×•×›×Ÿ', false);
                return;
            }

            const mimeType = exportType === 'excel' ? 'text/csv;charset=utf-8;' : 'application/json;charset=utf-8;';
            const blob = new Blob([fileContent], { type: mimeType });

            try {
                if (method === 5) {
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.style.display = 'none';
                    a.href = url;
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    setTimeout(() => {
                        document.body.removeChild(a);
                        URL.revokeObjectURL(url);
                    }, 100);
                    showStatus('âœ… × ×©××¨ ×‘-Downloads!');
                } else if (method === 3) {
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = filename;
                    a.click();
                    setTimeout(() => URL.revokeObjectURL(url), 100);
                    showStatus('âœ… × ×©××¨ ×‘-Downloads!');
                } else if (method === 4) {
                    const dataUrl = 'data:' + mimeType + ',' + encodeURIComponent(fileContent);
                    const a = document.createElement('a');
                    a.href = dataUrl;
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    showStatus('âœ… × ×©××¨ ×‘-Downloads!');
                } else if (method === 8) {
                    const dataUrl = 'data:' + mimeType + ',' + encodeURIComponent(fileContent);
                    window.open(dataUrl, '_blank');
                    showStatus('âœ… × ×¤×ª×— ×˜××‘ ×—×“×©!');
                } else if (method === 'cascade') {
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.style.display = 'none';
                    a.href = url;
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    setTimeout(() => {
                        document.body.removeChild(a);
                        URL.revokeObjectURL(url);
                    }, 100);
                    showStatus('âœ… × ×©××¨ ×‘-Downloads!');
                }
            } catch (error) {
                showStatus('âŒ ×©×’×™××”: ' + error.message, false);
            }
        }

        function closeWindow() {
            window.close();
        }

        window.addEventListener('load', loadData);
    </script>
</body>
</html>

<!DOCTYPE html>
<html dir="rtl" lang="he">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>×™×™×¦×•× ×§×‘×¦×™×</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 15px;
        }
        .container {
            background: white;
            border-radius: 20px;
            padding: 25px;
            max-width: 650px;
            margin: 0 auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        h1 {
            color: #667eea;
            margin-bottom: 8px;
            font-size: 24px;
            text-align: center;
        }
        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 20px;
            font-size: 13px;
        }
        .file-type {
            background: #f3f4f6;
            padding: 12px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: bold;
            color: #374151;
        }
        .methods {
            display: grid;
            gap: 10px;
            margin-bottom: 15px;
        }
        .method-btn {
            padding: 14px 18px;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            background: white;
            cursor: pointer;
            transition: all 0.2s;
            text-align: right;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .method-btn:hover {
            border-color: #667eea;
            background: #f9fafb;
            transform: translateY(-2px);
        }
        .method-btn:active {
            transform: translateY(0);
        }
        .method-num {
            background: #667eea;
            color: white;
            padding: 5px 11px;
            border-radius: 6px;
            font-weight: bold;
            font-size: 13px;
            min-width: 75px;
            text-align: center;
        }
        .method-desc {
            flex: 1;
            color: #374151;
            font-weight: 500;
            font-size: 14px;
        }
        .status {
            background: #f3f4f6;
            padding: 12px;
            border-radius: 8px;
            margin-top: 15px;
            font-size: 13px;
            color: #374151;
            min-height: 50px;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .status.success {
            background: #d1fae5;
            color: #065f46;
        }
        .status.error {
            background: #fee2e2;
            color: #991b1b;
        }
        .btn-close {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 8px;
            background: #ef4444;
            color: white;
            font-weight: bold;
            cursor: pointer;
            margin-top: 15px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“Š ×™×™×¦×•× ×§×‘×¦×™×</h1>
        <p class="subtitle">×‘×—×¨ ×©×™×˜×ª ×©××™×¨×” ××•×¢×“×¤×ª</p>
        
        <div class="file-type" id="fileType">×˜×•×¢×Ÿ...</div>
        
        <div class="methods">
            <button class="method-btn" onclick="testMethod(3)">
                <span class="method-num">×©×™×˜×” 3</span>
                <span class="method-desc">Blob + Download Link</span>
            </button>
            
            <button class="method-btn" onclick="testMethod(4)">
                <span class="method-num">×©×™×˜×” 4</span>
                <span class="method-desc">Data URL + Anchor</span>
            </button>
            
            <button class="method-btn" onclick="testMethod(5)">
                <span class="method-num">×©×™×˜×” 5</span>
                <span class="method-desc">Object URL + Click (××•××œ×¥)</span>
            </button>
            
            <button class="method-btn" onclick="testMethod(8)">
                <span class="method-num">×©×™×˜×” 8</span>
                <span class="method-desc">Window.open Data URL</span>
            </button>
            
            <button class="method-btn" onclick="testMethod('cascade')">
                <span class="method-num">××¤×œ ×—×›×</span>
                <span class="method-desc">× ×¡×” ××ª ×›×•×œ× ×¢×“ ×©×¢×•×‘×“</span>
            </button>
        </div>
        
        <div id="status" class="status">
            ×‘×—×¨ ×©×™×˜×” ×œ×‘×“×™×§×”...
        </div>
        
        <button class="btn-close" onclick="window.close()">âœ–ï¸ ×¡×’×•×¨</button>
    </div>

    <script>
        let appData = null;
        let exportType = 'excel'; // excel or json
        let fileContent = '';
        let filename = '';

        // ×˜×¢×Ÿ × ×ª×•× ×™× ×-localStorage
        function loadData() {
            try {
                const stored = localStorage.getItem('feedbackAppData');
                const type = localStorage.getItem('exportType') || 'excel';
                exportType = type;
                
                if (stored) {
                    appData = JSON.parse(stored);
                    console.log('âœ… Data loaded:', appData);
                    generateFileContent();
                    updateUI();
                } else {
                    showStatus('âŒ ×œ× × ××¦××• × ×ª×•× ×™×!', false);
                }
            } catch (e) {
                console.error('Load error:', e);
                showStatus('âŒ ×©×’×™××” ×‘×˜×¢×™× ×ª × ×ª×•× ×™×', false);
            }
        }

        function generateFileContent() {
            if (!appData) return;
            
            if (exportType === 'excel') {
                fileContent = generateCSV();
                filename = '××©×•×‘-×¡×“× ×”_' + new Date().toISOString().slice(0, 10) + '.csv';
            } else {
                fileContent = JSON.stringify(appData, null, 2);
                filename = '×”×’×“×¨×•×ª-×× ×”×œ_' + new Date().toISOString().slice(0, 10) + '.json';
            }
        }

        function generateCSV() {
            let csv = '\uFEFF'; // UTF-8 BOM
            
            csv += '×©× ×”×”×¢×¨×›×”,' + (appData.assessmentName || '') + '\n';
            csv += '××¢×¨×™×š,' + (appData.evaluatorName || '') + '\n';
            csv += '×ª××¨×™×š,' + new Date().toLocaleDateString('he-IL') + '\n\n';
            
            csv += '×—× ×™×›×™×\n';
            for (let i = 1; i <= 4; i++) {
                csv += i + ',' + (appData['trainee' + i] || '') + '\n';
            }
            csv += '\n';
            
            csv += '×“×’×©×™×,' + (appData.highlights || '') + '\n\n';
            
            csv += '×”×™×¡×˜×•×¨×™×™×ª ×—× ×•×™×•×ª\n';
            csv += '×©×,×›×ª×•×‘×ª,×ª××¨×™×š,×”×¢×¨×•×ª\n';
            if (appData.storeHistory && appData.storeHistory.length > 0) {
                appData.storeHistory.forEach(s => {
                    csv += (s.name || '') + ',' + (s.address || '') + ',' + (s.date || '') + ',' + (s.notes || '') + '\n';
                });
            }
            csv += '\n';
            
            csv += '×”×™×¡×˜×•×¨×™×™×ª ××œ×•× ×•×ª\n';
            csv += '×©×,×›×ª×•×‘×ª,×ª××¨×™×š,×”×¢×¨×•×ª\n';
            if (appData.hotelHistory && appData.hotelHistory.length > 0) {
                appData.hotelHistory.forEach(h => {
                    csv += (h.name || '') + ',' + (h.address || '') + ',' + (h.date || '') + ',' + (h.notes || '') + '\n';
                });
            }
            
            return csv;
        }

        function updateUI() {
            const fileTypeDiv = document.getElementById('fileType');
            if (exportType === 'excel') {
                fileTypeDiv.textContent = 'ğŸ“Š ×™×™×¦×•× Excel (CSV)';
                fileTypeDiv.style.background = 'linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%)';
            } else {
                fileTypeDiv.textContent = 'ğŸ“„ ×™×™×¦×•× JSON';
                fileTypeDiv.style.background = 'linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%)';
            }
        }

        function showStatus(message, isSuccess = true) {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = 'status ' + (isSuccess ? 'success' : 'error');
        }

        function testMethod(method) {
            if (!fileContent) {
                showStatus('âŒ ××™×Ÿ ×ª×•×›×Ÿ ×œ×™×™×¦×•×', false);
                return;
            }

            const mimeType = exportType === 'excel' ? 'text/csv;charset=utf-8;' : 'application/json;charset=utf-8;';
            const blob = new Blob([fileContent], { type: mimeType });

            try {
                if (method === 3) {
                    // Blob + download link
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = filename;
                    a.click();
                    setTimeout(() => URL.revokeObjectURL(url), 100);
                    showStatus('âœ… ×©×™×˜×” 3: × ×™×¡×™×•×Ÿ ×”×•×¨×“×”! ×‘×“×•×§ Downloads');
                    
                } else if (method === 4) {
                    // Data URL + anchor
                    const dataUrl = 'data:' + mimeType + ',' + encodeURIComponent(fileContent);
                    const a = document.createElement('a');
                    a.href = dataUrl;
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    showStatus('âœ… ×©×™×˜×” 4: × ×™×¡×™×•×Ÿ ×”×•×¨×“×”! ×‘×“×•×§ Downloads');
                    
                } else if (method === 5) {
                    // Object URL + click (×”×›×™ ×××™× ×”!)
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.style.display = 'none';
                    a.href = url;
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    setTimeout(() => {
                        document.body.removeChild(a);
                        URL.revokeObjectURL(url);
                    }, 100);
                    showStatus('âœ… ×©×™×˜×” 5: ×”×§×•×‘×¥ ×××•×¨ ×œ×”×™×•×ª ×‘-Downloads!');
                    
                } else if (method === 8) {
                    // window.open
                    const dataUrl = 'data:' + mimeType + ',' + encodeURIComponent(fileContent);
                    window.open(dataUrl, '_blank');
                    showStatus('âœ… ×©×™×˜×” 8: × ×¤×ª×— ×˜××‘ ×—×“×©');
                    
                } else if (method === 'cascade') {
                    // ××¤×œ ×—×›× - × ×¡×” 5 â†’ 3 â†’ 4 â†’ 8
                    let success = false;
                    
                    try {
                        // × ×¡×” 5
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.style.display = 'none';
                        a.href = url;
                        a.download = filename;
                        document.body.appendChild(a);
                        a.click();
                        setTimeout(() => {
                            document.body.removeChild(a);
                            URL.revokeObjectURL(url);
                        }, 100);
                        showStatus('âœ… ××¤×œ ×—×›×: ×”×¦×œ×™×— ×‘×©×™×˜×” 5!');
                        success = true;
                    } catch (e1) {
                        try {
                            // × ×¡×” 3
                            const url = URL.createObjectURL(blob);
                            const a = document.createElement('a');
                            a.href = url;
                            a.download = filename;
                            a.click();
                            setTimeout(() => URL.revokeObjectURL(url), 100);
                            showStatus('âœ… ××¤×œ ×—×›×: ×”×¦×œ×™×— ×‘×©×™×˜×” 3!');
                            success = true;
                        } catch (e2) {
                            try {
                                // × ×¡×” 4
                                const dataUrl = 'data:' + mimeType + ',' + encodeURIComponent(fileContent);
                                const a = document.createElement('a');
                                a.href = dataUrl;
                                a.download = filename;
                                a.click();
                                showStatus('âœ… ××¤×œ ×—×›×: ×”×¦×œ×™×— ×‘×©×™×˜×” 4!');
                                success = true;
                            } catch (e3) {
                                try {
                                    // × ×¡×” 8
                                    const dataUrl = 'data:' + mimeType + ',' + encodeURIComponent(fileContent);
                                    window.open(dataUrl, '_blank');
                                    showStatus('âœ… ××¤×œ ×—×›×: ×”×¦×œ×™×— ×‘×©×™×˜×” 8!');
                                    success = true;
                                } catch (e4) {
                                    showStatus('âŒ ×›×œ ×”×©×™×˜×•×ª × ×›×©×œ×•!', false);
                                }
                            }
                        }
                    }
                }
                
            } catch (error) {
                showStatus('âŒ ×©×’×™××”: ' + error.message, false);
            }
        }

        // ×˜×¢×Ÿ × ×ª×•× ×™× ×‘×˜×¢×™× ×ª ×”×“×£
        window.addEventListener('load', loadData);
    </script>
</body>
</html>

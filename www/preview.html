<!DOCTYPE html>
<html dir="rtl" lang="he">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>×ª×¦×•×’×” ××§×“×™××”</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            background: #f5f5f5;
            padding: 10px;
        }
        .header {
            background: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: sticky;
            top: 10px;
            z-index: 100;
        }
        h1 {
            color: #667eea;
            font-size: 20px;
            margin-bottom: 12px;
            text-align: center;
        }
        .btn-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        .btn {
            padding: 14px;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn:active {
            transform: scale(0.95);
        }
        .btn-share {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }
        .btn-close {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
        }
        .preview {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            white-space: pre-wrap;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.6;
            overflow-x: auto;
        }
        .status {
            background: #d1fae5;
            color: #065f46;
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            text-align: center;
            font-size: 13px;
            display: none;
        }
        .status.show {
            display: block;
        }
        .status.error {
            background: #fee2e2;
            color: #991b1b;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ‘ï¸ ×ª×¦×•×’×” ××§×“×™××” - Excel</h1>
        <div class="btn-row">
            <button class="btn btn-share" onclick="shareFile()">
                ğŸ“¤ ×©×™×ª×•×£ (Android)
            </button>
            <button class="btn btn-close" onclick="closeWindow()">
                âœ–ï¸ ×¡×’×•×¨
            </button>
        </div>
        <div id="status" class="status"></div>
    </div>
    
    <div class="preview" id="preview">×˜×•×¢×Ÿ × ×ª×•× ×™×...</div>

    <script>
        let csvContent = '';
        let appData = null;

        function showStatus(message, isError = false) {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = 'status show' + (isError ? ' error' : '');
            setTimeout(() => {
                status.className = 'status';
            }, 3000);
        }

        function generateFullCSV(data) {
            let csv = '\uFEFF'; // UTF-8 BOM
            
            // ×›×•×ª×¨×ª
            csv += '=== × ×ª×•× ×™ ×”×¢×¨×›×” ===\n\n';
            csv += '×©××œ×”: ×©× ×”×”×¢×¨×›×”\n';
            csv += '×ª×©×•×‘×”: ' + (data.assessmentName || '×œ× ××•×œ×') + '\n\n';
            
            csv += '×©××œ×”: ×©× ×”××¢×¨×™×š\n';
            csv += '×ª×©×•×‘×”: ' + (data.evaluatorName || '×œ× ××•×œ×') + '\n\n';
            
            csv += '×ª××¨×™×š: ' + new Date().toLocaleDateString('he-IL') + '\n\n';
            
            // ×—× ×™×›×™×
            csv += '=== ×—× ×™×›×™× ===\n\n';
            for (let i = 1; i <= 4; i++) {
                csv += '×©××œ×”: ×—× ×™×š ' + i + '\n';
                csv += '×ª×©×•×‘×”: ' + (data['trainee' + i] || '×œ× ××•×œ×') + '\n\n';
            }
            
            // ×“×’×©×™×
            csv += '=== ×“×’×©×™× ===\n\n';
            csv += '×©××œ×”: ×“×’×©×™× ×›×œ×œ×™×™×\n';
            csv += '×ª×©×•×‘×”: ' + (data.highlights || '×œ× ××•×œ×') + '\n\n';
            
            // ×ª×¨×’×™×œ ×‘×œ×•×Ÿ - ×›×œ 4 ×—× ×™×›×™×
            csv += '=== ×ª×¨×’×™×œ ×‘×œ×•×Ÿ ===\n\n';
            for (let t = 0; t < 4; t++) {
                const traineeName = data['trainee' + (t + 1)] || '×—× ×™×š ' + (t + 1);
                csv += '×—× ×™×š: ' + traineeName + '\n';
                
                csv += '  ×©××œ×”: ×’××™×©×•×ª ××—×©×‘×ª×™×ª\n';
                csv += '  ×ª×©×•×‘×”: ' + (data[`${t}-×’××™×©×•×ª`] || '×œ× ××•×œ×') + '\n';
                
                csv += '  ×©××œ×”: ×ª×›× ×•×Ÿ\n';
                csv += '  ×ª×©×•×‘×”: ' + (data[`${t}-×ª×›× ×•×Ÿ`] || '×œ× ××•×œ×') + '\n';
                
                csv += '  ×©××œ×”: ×œ×—×¥ ×•×¢××™××•×ª\n';
                csv += '  ×ª×©×•×‘×”: ' + (data[`${t}-×œ×—×¥`] || '×œ× ××•×œ×') + '\n';
                
                csv += '  ×©××œ×”: ×”×¢×¨×•×ª\n';
                csv += '  ×ª×©×•×‘×”: ' + (data[`balloon-${t}-notes`] || '×œ× ××•×œ×') + '\n\n';
            }
            
            // ×ª×¨×’×™×œ ×˜×™×— - ×›×œ 4 ×—× ×™×›×™×
            csv += '=== ×ª×¨×’×™×œ ×˜×™×— ===\n\n';
            for (let t = 0; t < 4; t++) {
                const traineeName = data['trainee' + (t + 1)] || '×—× ×™×š ' + (t + 1);
                csv += '×—× ×™×š: ' + traineeName + '\n';
                
                csv += '  ×©××œ×”: ×—× ×•×ª\n';
                csv += '  ×ª×©×•×‘×”: ' + (data[`tiach-${t}-store`] || '×œ× ××•×œ×') + '\n';
                
                csv += '  ×©××œ×”: ×¦×™×•×Ÿ\n';
                csv += '  ×ª×©×•×‘×”: ' + (data[`tiach-${t}-score`] || '×œ× ××•×œ×') + '\n';
                
                csv += '  ×©××œ×”: ×”×¢×¨×•×ª\n';
                csv += '  ×ª×©×•×‘×”: ' + (data[`tiach-${t}-notes`] || '×œ× ××•×œ×') + '\n\n';
            }
            
            // ×ª×¨×’×™×œ ×“×•×œ×™×¨×” - ×›×œ 4 ×—× ×™×›×™×
            csv += '=== ×ª×¨×’×™×œ ×“×•×œ×™×¨×” ===\n\n';
            for (let t = 0; t < 4; t++) {
                const traineeName = data['trainee' + (t + 1)] || '×—× ×™×š ' + (t + 1);
                csv += '×—× ×™×š: ' + traineeName + '\n';
                
                csv += '  ×©××œ×”: ×–××Ÿ\n';
                csv += '  ×ª×©×•×‘×”: ' + (data[`dolira-${t}-time`] || '×œ× ××•×œ×') + '\n';
                
                csv += '  ×©××œ×”: ××™×›×•×ª\n';
                csv += '  ×ª×©×•×‘×”: ' + (data[`dolira-${t}-quality`] || '×œ× ××•×œ×') + '\n\n';
            }
            
            // ×ª×¨×’×™×œ ×“×•×“ - ×›×œ 4 ×—× ×™×›×™×
            csv += '=== ×ª×¨×’×™×œ ×“×•×“ ===\n\n';
            for (let t = 0; t < 4; t++) {
                const traineeName = data['trainee' + (t + 1)] || '×—× ×™×š ' + (t + 1);
                csv += '×—× ×™×š: ' + traineeName + '\n';
                
                csv += '  ×©××œ×”: ×‘×™×¦×•×¢\n';
                csv += '  ×ª×©×•×‘×”: ' + (data[`david-${t}-score`] || '×œ× ××•×œ×') + '\n';
                
                csv += '  ×©××œ×”: ×”×¢×¨×•×ª\n';
                csv += '  ×ª×©×•×‘×”: ' + (data[`david-${t}-notes`] || '×œ× ××•×œ×') + '\n\n';
            }
            
            // ×ª×¨×’×™×œ ×œ×™×œ×” - ×›×œ 4 ×—× ×™×›×™×
            csv += '=== ×ª×¨×’×™×œ ×œ×™×œ×” ===\n\n';
            for (let t = 0; t < 4; t++) {
                const traineeName = data['trainee' + (t + 1)] || '×—× ×™×š ' + (t + 1);
                csv += '×—× ×™×š: ' + traineeName + '\n';
                
                csv += '  ×©××œ×”: ××œ×•×Ÿ\n';
                csv += '  ×ª×©×•×‘×”: ' + (data[`laila-${t}-hotel`] || '×œ× ××•×œ×') + '\n';
                
                csv += '  ×©××œ×”: ×¦×™×•×Ÿ\n';
                csv += '  ×ª×©×•×‘×”: ' + (data[`laila-${t}-score`] || '×œ× ××•×œ×') + '\n';
                
                csv += '  ×©××œ×”: ×”×¢×¨×•×ª\n';
                csv += '  ×ª×©×•×‘×”: ' + (data[`laila-${t}-notes`] || '×œ× ××•×œ×') + '\n\n';
            }
            
            // ×ª×¨×’×™×œ ××›×ª×‘ - ×›×œ 4 ×—× ×™×›×™×
            csv += '=== ×ª×¨×’×™×œ ××›×ª×‘ ===\n\n';
            for (let t = 0; t < 4; t++) {
                const traineeName = data['trainee' + (t + 1)] || '×—× ×™×š ' + (t + 1);
                csv += '×—× ×™×š: ' + traineeName + '\n';
                
                csv += '  ×©××œ×”: ×¦×™×•×Ÿ\n';
                csv += '  ×ª×©×•×‘×”: ' + (data[`michtav-${t}-score`] || '×œ× ××•×œ×') + '\n';
                
                csv += '  ×©××œ×”: ×”×¢×¨×•×ª\n';
                csv += '  ×ª×©×•×‘×”: ' + (data[`michtav-${t}-notes`] || '×œ× ××•×œ×') + '\n\n';
            }
            
            // ×ª×¨×’×™×œ ×™×•××™× ×˜ - ×›×œ 4 ×—× ×™×›×™×
            csv += '=== ×ª×¨×’×™×œ ×™×•××™× ×˜ ===\n\n';
            for (let t = 0; t < 4; t++) {
                const traineeName = data['trainee' + (t + 1)] || '×—× ×™×š ' + (t + 1);
                csv += '×—× ×™×š: ' + traineeName + '\n';
                
                csv += '  ×©××œ×”: ××œ×•×Ÿ\n';
                csv += '  ×ª×©×•×‘×”: ' + (data[`yominet-${t}-hotel`] || '×œ× ××•×œ×') + '\n';
                
                csv += '  ×©××œ×”: ×¦×™×•×Ÿ\n';
                csv += '  ×ª×©×•×‘×”: ' + (data[`yominet-${t}-score`] || '×œ× ××•×œ×') + '\n';
                
                csv += '  ×©××œ×”: ×”×¢×¨×•×ª\n';
                csv += '  ×ª×©×•×‘×”: ' + (data[`yominet-${t}-notes`] || '×œ× ××•×œ×') + '\n\n';
            }
            
            // ×”×™×¡×˜×•×¨×™×™×ª ×—× ×•×™×•×ª
            csv += '=== ×”×™×¡×˜×•×¨×™×™×ª ×—× ×•×™×•×ª ===\n\n';
            if (data.storeHistory && data.storeHistory.length > 0) {
                data.storeHistory.forEach((s, i) => {
                    csv += '×—× ×•×ª ' + (i + 1) + ':\n';
                    csv += '  ×©×: ' + (s.name || '×œ× ××•×œ×') + '\n';
                    csv += '  ×›×ª×•×‘×ª: ' + (s.address || '×œ× ××•×œ×') + '\n';
                    csv += '  ×ª××¨×™×š: ' + (s.date || '×œ× ××•×œ×') + '\n';
                    csv += '  ×”×¢×¨×•×ª: ' + (s.notes || '×œ× ××•×œ×') + '\n\n';
                });
            } else {
                csv += '××™×Ÿ × ×ª×•× ×™×\n\n';
            }
            
            // ×”×™×¡×˜×•×¨×™×™×ª ××œ×•× ×•×ª
            csv += '=== ×”×™×¡×˜×•×¨×™×™×ª ××œ×•× ×•×ª ===\n\n';
            if (data.hotelHistory && data.hotelHistory.length > 0) {
                data.hotelHistory.forEach((h, i) => {
                    csv += '××œ×•×Ÿ ' + (i + 1) + ':\n';
                    csv += '  ×©×: ' + (h.name || '×œ× ××•×œ×') + '\n';
                    csv += '  ×›×ª×•×‘×ª: ' + (h.address || '×œ× ××•×œ×') + '\n';
                    csv += '  ×ª××¨×™×š: ' + (h.date || '×œ× ××•×œ×') + '\n';
                    csv += '  ×”×¢×¨×•×ª: ' + (h.notes || '×œ× ××•×œ×') + '\n\n';
                });
            } else {
                csv += '××™×Ÿ × ×ª×•× ×™×\n\n';
            }
            
            return csv;
        }

        function shareFile() {
            if (!csvContent) {
                showStatus('âŒ ××™×Ÿ × ×ª×•× ×™× ×œ×©×™×ª×•×£', true);
                return;
            }

            console.log('ğŸ“¤ Attempting social share...');
            
            // ×‘×“×•×§ ×× Social Sharing Plugin ×–××™×Ÿ
            if (window.plugins && window.plugins.socialsharing) {
                console.log('âœ… Using Social Sharing Plugin');
                
                const filename = '××©×•×‘-×¡×“× ×”_' + new Date().toISOString().slice(0, 10) + '.csv';
                const base64 = 'data:text/csv;base64,' + btoa(unescape(encodeURIComponent(csvContent)));
                
                window.plugins.socialsharing.shareWithOptions({
                    message: '××©×•×‘ ×¡×“× ×ª ××™××¤×¨×•×‘×™×–×¦×™×” - × ×ª×•× ×™ ×”×¢×¨×›×”',
                    subject: '××©×•×‘ ×¡×“× ×”',
                    files: [base64],
                    chooserTitle: '×©×ª×£ ×§×•×‘×¥ Excel'
                }, function(result) {
                    console.log('âœ… Share success');
                    showStatus('âœ… ×©×™×ª×•×£ ×”×¦×œ×™×—!');
                }, function(error) {
                    console.error('âŒ Share failed:', error);
                    showStatus('âŒ ×©×™×ª×•×£ × ×›×©×œ', true);
                    fallbackDownload();
                });
            } else {
                console.warn('âš ï¸ Social Sharing Plugin not available, using fallback');
                fallbackDownload();
            }
        }
        
        function fallbackDownload() {
            console.log('ğŸ’¾ Fallback: downloading file');
            
            const filename = '××©×•×‘-×¡×“× ×”_' + new Date().toISOString().slice(0, 10) + '.csv';
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            
            setTimeout(() => {
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }, 100);
            
            showStatus('âœ… ×”×§×•×‘×¥ ×”×•×¨×“ ×œ-Downloads!');
        }

        function closeWindow() {
            // × ×¡×” ×œ×¡×’×•×¨ ××ª ×”×—×œ×•×Ÿ
            window.close();
            
            // ×× ×œ× ×¢×‘×“, × ×¡×” ×œ×—×–×•×¨ ××—×•×¨×”
            setTimeout(() => {
                if (window.opener) {
                    window.opener.focus();
                    window.close();
                } else if (window.history.length > 1) {
                    window.history.back();
                } else {
                    // ×× ×›×œ×•× ×œ× ×¢×‘×“, × ×¡×” ×œ× ×•×•×˜ ×œ×“×£ ×¡×™×›×•×
                    window.location.href = 'index.html#summary';
                }
            }, 100);
        }

        // ×˜×¢×Ÿ × ×ª×•× ×™×
        window.addEventListener('load', function() {
            try {
                const stored = localStorage.getItem('feedbackAppData');
                if (stored) {
                    appData = JSON.parse(stored);
                    csvContent = generateFullCSV(appData);
                    
                    // ×”×¦×’ ×ª×¦×•×’×” ××§×“×™××”
                    document.getElementById('preview').textContent = csvContent;
                    showStatus('âœ… ××•×›×Ÿ ×œ×©×™×ª×•×£!');
                } else {
                    document.getElementById('preview').textContent = 'âŒ ×œ× × ××¦××• × ×ª×•× ×™×';
                    showStatus('âŒ ×œ× ×”×ª×§×‘×œ×• × ×ª×•× ×™×', true);
                }
            } catch (error) {
                document.getElementById('preview').textContent = 'âŒ ×©×’×™××”: ' + error.message;
                showStatus('âŒ ×©×’×™××” ×‘×˜×¢×™× ×ª × ×ª×•× ×™×', true);
            }
        });
    </script>
</body>
</html>
